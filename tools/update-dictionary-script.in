#!/bin/bash

set -e

if [ "$EUID" -ne 0 ]
	then echo "Please run as root"
	exit
fi

if [ -f /etc/libcifpp.conf ] ; then
	. /etc/libcifpp.conf
fi

# check to see if we're supposed to run at all
if [ "$update" != "true" ] ; then
	exit
fi

# if cache directory doesn't exist, exit. 
if ! [ -d @CIFPP_CACHE_DIR@ ]; then
	exit
fi

fetch_dictionary () {
	dict=$1
	source=$2

	wget -O${dict}.gz ${source}

	# be careful not to nuke an existing dictionary file
	# extract to a temporary file first

	gunzip -c ${dict}.gz > ${dict}-tmp

	# then move the extracted file to the final location

	mv ${dict}-tmp ${dict}

	# and clean up afterwards

	rm ${dict}.gz
}

# fetch the dictionaries

fetch_dictionary "@CIFPP_CACHE_DIR@/mmcif_pdbx_v50.dic" "https://mmcif.wwpdb.org/dictionaries/ascii/mmcif_pdbx_v50.dic.gz"
fetch_dictionary "@CIFPP_CACHE_DIR@/components.cif" "ftp://ftp.wwpdb.org/pub/pdb/data/monomers/components.cif.gz"

# update OpenStructure compounds.chemlib

if [ -f /usr/bin/chemdict_tool ] ; then
    tmp_dir=$(mktemp --directory)
    chown nobody:nogroup "${tmp_dir}"

    gzip -c "@CIFPP_CACHE_DIR@/components.cif" > "${tmp_dir}/components.cif.gz"

    # lowering privileges in order not to run as root
    runuser -u nobody -- /usr/bin/chemdict_tool create "${tmp_dir}/components.cif.gz" "${tmp_dir}/compounds.chemlib" pdb

    mkdir --parents /var/cache/openstructure
    mv "${tmp_dir}/compounds.chemlib" /var/cache/openstructure/compounds.chemlib
    chown root:root /var/cache/openstructure/compounds.chemlib
    rm -rf "${tmp_dir}"
fi
